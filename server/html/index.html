<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Инфо-доска дня</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #fff;
      color: #000;
      width: 800px;
      height: 480px;
      display: flex;
      flex-direction: column;
    }
    header {
      height: 80px;
      text-align: center;
      padding: 5px 10px 0;
      box-sizing: border-box;
    }
    header h1 {
      margin: 0;
      font-size: 32px;
      line-height: 1.1;
    }
    header p {
      margin: 2px 0;
      font-size: 14px;
      line-height: 1.2;
    }
    #weather {
      font-size: 12px !important;
      margin: 2px 0 !important;
      font-weight: normal;
    }
    .header-weather {
      font-size: 20px;
      font-weight: bold;
      margin: 4px 0;
    }
    main {
      display: flex;
      flex: 1;
    }
    section {
      width: 400px;
      padding: 10px;
      box-sizing: border-box;
      border-right: 1px solid #000;
    }
    section:last-child {
      border-right: none;
    }
    .block {
      margin-bottom: 20px;
    }
    .block h2 {
      font-size: 18px;
      margin-bottom: 5px;
      border-bottom: 1px solid #000;
    }
    .block p {
      margin: 4px 0;
      font-size: 14px;
      line-height: 1.4;
    }
    .quote {
      font-style: italic;
    }
    .error {
      color: #d32f2f;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="time">--:--</h1>
    <p id="date">Загрузка даты...</p>
    <p id="weather-main" class="header-weather">Загрузка погоды...</p>
  </header>
  <div style="border-bottom: 2px solid #000; margin: 5px auto 0; width: 760px;"></div>
  <main>
    <section>
      <div class="block">
        <h2>Курс валют</h2>
        <p id="usd">USD: загрузка...</p>
        <p id="eur">EUR: загрузка...</p>
        <p id="rub">RUB: загрузка...</p>
        <p id="btc">BTC: загрузка...</p>
      </div>
      <div class="block">
        <h2>Прогноз погоды</h2>
        <p id="weather-details" style="font-size: 12px; margin: 2px 0;"></p>
      </div>
      <div class="block">
        <h2>Цитата дня</h2>
        <p class="quote" id="quote">Загрузка цитаты...</p>
        <p id="author"></p>
      </div>
    </section>
    <section>
      <div class="block">
        <h2>Новости</h2>
        <p id="news1">Загрузка...</p>
        <p id="news2"></p>
        <p id="news3"></p>
      </div>
      <div class="block">
        <h2>Новости физики</h2>
        <p id="physics-news">Загрузка...</p>
      </div>
      <div class="block">
        <h2>Календарь</h2>
        <p id="calendar1">Загрузка...</p>
        <p id="calendar2"></p>
      </div>
    </section>
  </main>

  <script>
    // Обновление времени и даты
    function updateDateTime() {
      const now = new Date();
      document.getElementById('time').textContent = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      document.getElementById('date').textContent = now.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    }
    
    // Обновлять время каждую секунду
    updateDateTime();
    setInterval(updateDateTime, 1000);

    // Функция для безопасного выполнения запросов с таймаутом (5 сек)
    async function safeFetch(url, fallback, timeout = 5000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const response = await fetch(url, { signal: controller.signal });
        clearTimeout(id);
        if (!response.ok) throw new Error('Network response was not ok');
        return await response.json();
      } catch (error) {
        clearTimeout(id);
        console.error(`Error fetching ${url}:`, error);
        return fallback;
      }
    }

    // Курс валют - NBRB RSS
    async function loadCurrencyRates() {
      try {
        const rssUrl = 'https://www.nbrb.by/rss/?p=ratesdaily&l=ru';
        const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;
        
        const rssData = await safeFetch(apiUrl, null);
        
        if (rssData && rssData.items && rssData.items.length > 0) {
          const item = rssData.items[0];
          const description = item.description;
          
          // Функция парсинга: ищет название валюты и следующее за ним число
          const getRate = (pattern) => {
             // pattern example: "1 Доллар США"
             // Regex looks for pattern, optional spaces, then captures digits/commas
             const regex = new RegExp(`${pattern}\\s+([\\d,]+)`, 'i');
             const match = description.match(regex);
             return match ? match[1] : '---';
          };

          const usd = getRate('1 Доллар США');
          const eur = getRate('1 Евро');
          const rub = getRate('100 Российских рублей');
          
          document.getElementById('usd').textContent = `1 USD = ${usd} BYN`;
          document.getElementById('eur').textContent = `1 EUR = ${eur} BYN`;
          document.getElementById('rub').textContent = `100 RUB = ${rub} BYN`;
        } else {
          throw new Error('Invalid NBRB data');
        }
      } catch (error) {
        console.error('Currency load error:', error);
        // Fallback to example data provided
        document.getElementById('usd').textContent = `1 USD = 2.9220 BYN`;
        document.getElementById('eur').textContent = `1 EUR = 3.3819 BYN`;
        document.getElementById('rub').textContent = `100 RUB = 3.7056 BYN`;
        document.getElementById('rub').innerHTML += '<span class="error"> (оффлайн)</span>';
      }
    }

    // Курс BTC
    async function loadBTCPrice() {
      try {
        const btcData = await safeFetch('https://api.coindesk.com/v1/bpi/currentprice.json', null);
        if (btcData && btcData.bpi && btcData.bpi.USD) {
          const btcPrice = parseFloat(btcData.bpi.USD.rate.replace(',', ''));
          document.getElementById('btc').textContent = `1 BTC = $${btcPrice.toLocaleString()}`;
        } else {
          throw new Error('Invalid BTC data');
        }
      } catch (error) {
        document.getElementById('btc').textContent = `1 BTC = $95,000`;
        document.getElementById('btc').innerHTML += '<span class="error"> (оффлайн)</span>';
      }
    }

    // Погода для Минска
    async function loadWeather() {
      try {
        // Получаем детальную погодную информацию с OpenWeatherMap на русском языке
        const response = await fetch('http://api.openweathermap.org/data/2.5/weather?q=Minsk&appid=99fc51e4e132d3e0a465294f293ad82a&units=metric&lang=ru');
        if (!response.ok) throw new Error('Weather API failed');
        const weatherData = await response.json();
        
        const temp = Math.round(weatherData.main.temp);
        const description = weatherData.weather[0].description;
        const humidity = weatherData.main.humidity;
        const pressure = Math.round(weatherData.main.pressure);
        const windSpeed = Math.round(weatherData.wind.speed * 3.6); // м/с в км/ч
        
        // Основная строка с температурой и городом
        document.getElementById('weather-main').textContent = `Минск ${temp}°C`;
        
        // Детальная информация ниже
        const details = `${description}, ветер ${windSpeed} км/ч, ${humidity}% влаж., ${pressure} мбар`;
        document.getElementById('weather-details').textContent = details;
      } catch (error) {
        try {
          // Запасной вариант с wttr.in
          const response = await fetch('https://wttr.in/Minsk?format=%t+%C+%w+%h+%P&lang=ru');
          if (!response.ok) throw new Error('Weather API failed');
          const weatherText = await response.text();
          const parts = weatherText.split(' ');
          const temp = parts[0];
          const desc = parts[1];
          const wind = parts[2] || '2км/ч';
          
          document.getElementById('weather-main').textContent = `Минск ${temp}`;
          document.getElementById('weather-details').textContent = `${desc}, ветер ${wind}, 65% влаж., 1013 мбар`;
        } catch (fallbackError) {
          document.getElementById('weather-main').textContent = 'Минск +2°C';
          document.getElementById('weather-details').textContent = 'Облачно, ветер 5 км/ч, 65% влаж., 1013 мбар';
          document.getElementById('weather-main').textContent = 'Минск +2°C';
        }
      }
    }

    // Цитата дня
    async function loadQuote() {
      try {
        const rssData = await safeFetch('https://api.rss2json.com/v1/api.json?rss_url=http://www.aphorisme.ru/xml/last_aphors.xml', null);
        if (rssData && rssData.items && rssData.items.length > 0) {
          const item = rssData.items[0];
          document.getElementById('quote').textContent = `«${item.description}»`;
          document.getElementById('author').textContent = `— ${item.title}`;
        } else {
          throw new Error('Invalid quote data');
        }
      } catch (error) {
        // Запасная цитата
        document.getElementById('quote').textContent = "Лучшее время посадить дерево было 20 лет назад. Второе лучшее время - сейчас.";
        document.getElementById('author').textContent = "- Китайская пословица";
        document.getElementById('quote').innerHTML += '<span class="error"> (оффлайн)</span>';
      }
    }

    // Новости (используем несколько источников для надежности)
    async function loadNews() {
      try {
        const newsData = await safeFetch('https://api.rss2json.com/v1/api.json?rss_url=https://tass.ru/rss/v2.xml', null);
        if (newsData && newsData.items && newsData.items.length >= 3) {
          const items = newsData.items.slice(0, 3);
          document.getElementById('news1').textContent = `• ${items[0].title.substring(0, 80)}...`;
          document.getElementById('news2').textContent = `• ${items[1].title.substring(0, 80)}...`;
          document.getElementById('news3').textContent = `• ${items[2].title.substring(0, 80)}...`;
        } else {
          throw new Error('Invalid news data');
        }
      } catch (error) {
        // Запасные новости
        document.getElementById('news1').textContent = '• Экономика Беларуси показывает стабильный рост в текущем квартале';
        document.getElementById('news2').textContent = '• В Минске открыли новую станцию метро';
        document.getElementById('news3').textContent = '• Белорусские IT-компании представили новые разработки';
        document.getElementById('news1').innerHTML += '<span class="error"> (оффлайн)</span>';
      }
    }

    // Новости физики
    async function loadPhysics() {
      try {
        const rssData = await safeFetch('https://api.rss2json.com/v1/api.json?rss_url=https://elementy.ru/rss/news/physics', null);
        if (rssData && rssData.items && rssData.items.length > 0) {
          const item = rssData.items[0];
          // Простая очистка HTML тегов для описания
          const cleanDesc = item.description.replace(/<[^>]*>?/gm, '').substring(0, 120).trim();
          
          document.getElementById('physics-news').innerHTML = `<b>${item.title}</b><br><span style="font-size:13px">${cleanDesc}...</span>`;
        } else {
          throw new Error('Invalid physics data');
        }
      } catch (error) {
        document.getElementById('physics-news').textContent = 'Физика: данные временно недоступны.';
        document.getElementById('physics-news').innerHTML += '<span class="error"> (оффлайн)</span>';
      }
    }

    // Календарь знаменательных дат
    function loadCalendar() {
      const today = new Date();
      const month = today.getMonth() + 1;
      const day = today.getDate();
      
      // Примеры знаменательных дат
      const events = {
        '1-1': ['Новый год', 'Международный день мира'],
        '2-14': ['День Святого Валентина'],
        '3-8': ['Международный женский день'],
        '4-1': ['День смеха'],
        '5-1': ['День труда'],
        '5-9': ['День Победы'],
        '6-1': ['День защиты детей'],
        '7-3': ['День независимости Беларуси'],
        '9-1': ['День знаний'],
        '10-1': ['Международный день пожилых'],
        '11-7': ['Октябрьская революция'],
        '12-25': ['Рождество Христово']
      };
      
      const key = `${month}-${day}`;
      const dayEvents = events[key] || ['Обычный день'];
      
      document.getElementById('calendar1').textContent = `• ${dayEvents[0]}`;
      if (dayEvents[1]) {
        document.getElementById('calendar2').textContent = `• ${dayEvents[1]}`;
      } else {
        document.getElementById('calendar2').textContent = '• День хорошего настроения';
      }
    }

    // Загрузка всех данных
    async function loadAllData() {
      await Promise.all([
        loadCurrencyRates(),
        loadBTCPrice(),
        loadWeather(),
        loadQuote(),
        loadNews(),
        loadPhysics()
      ]);
      loadCalendar();
      document.body.classList.add('data-loaded');
    }

    // Загружаем данные при загрузке страницы (только один раз)
    loadAllData();
  </script>
</body>
</html>
